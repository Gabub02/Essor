<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Termin Manager Pro</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<script type="module" src="/src/supabase.js"></script>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  background: #0d0d14;
  color: #f0f0ff;
  font-family: 'Syne', sans-serif;
  min-height: 100vh;
  display: flex;
  justify-content: center;
}
.app {
  width: 100%;
  max-width: 440px;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  padding-bottom: 80px;
}

/* ‚îÄ‚îÄ SETUP SCREEN ‚îÄ‚îÄ */
#setupScreen {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 100vh;
  padding: 30px 24px;
  text-align: center;
}
.setup-logo { font-size: 56px; margin-bottom: 16px; }
.setup-title { font-size: 28px; font-weight: 800; background: linear-gradient(135deg, #8b84ff, #a78bfa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 8px; }
.setup-sub { color: #6b6b8a; font-size: 14px; margin-bottom: 32px; line-height: 1.6; }
.setup-card { background: #1a1a24; border: 1px solid #2a2a3a; border-radius: 20px; padding: 24px; width: 100%; margin-bottom: 16px; text-align: left; }
.setup-card h3 { font-size: 14px; color: #8b84ff; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 16px; }
.role-btn {
  width: 100%;
  padding: 16px;
  border-radius: 14px;
  border: 2px solid #2a2a3a;
  background: #0d0d14;
  color: #f0f0ff;
  font-family: 'Syne', sans-serif;
  font-size: 16px;
  font-weight: 700;
  cursor: pointer;
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  gap: 14px;
  transition: all 0.2s;
}
.role-btn:hover { border-color: #6c63ff; background: #6c63ff11; }
.role-btn .icon { font-size: 28px; }
.role-btn .desc { font-size: 12px; color: #6b6b8a; font-weight: 400; margin-top: 2px; }

/* ‚îÄ‚îÄ CHANNEL SETUP ‚îÄ‚îÄ */
#channelScreen {
  display: none;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 100vh;
  padding: 30px 24px;
}
.channel-card { background: #1a1a24; border: 1px solid #2a2a3a; border-radius: 20px; padding: 24px; width: 100%; }
.channel-title { font-size: 22px; font-weight: 800; margin-bottom: 8px; }
.channel-sub { color: #6b6b8a; font-size: 13px; margin-bottom: 24px; line-height: 1.6; }
.steps { margin-bottom: 24px; }
.step { display: flex; gap: 14px; align-items: flex-start; margin-bottom: 16px; }
.step-num { background: #6c63ff; color: #fff; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 13px; flex-shrink: 0; margin-top: 2px; }
.step-text { font-size: 14px; line-height: 1.6; color: #ccc; }
.step-text strong { color: #f0f0ff; }
.channel-display { background: #0d0d14; border: 2px solid #6c63ff; border-radius: 12px; padding: 14px 16px; font-size: 18px; font-weight: 800; color: #8b84ff; letter-spacing: 2px; text-align: center; margin-bottom: 16px; word-break: break-all; }

/* ‚îÄ‚îÄ MAIN APP ‚îÄ‚îÄ */
#mainApp { display: none; flex-direction: column; flex: 1; }

.header {
  padding: 20px 20px 14px;
  background: linear-gradient(180deg, #1a1a24 0%, #0d0d14 100%);
  border-bottom: 1px solid #2a2a3a;
}
.header-top { display: flex; justify-content: space-between; align-items: center; }
.header-label { font-size: 11px; color: #6b6b8a; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 4px; }
.header-title { font-size: 24px; font-weight: 800; background: linear-gradient(135deg, #8b84ff, #a78bfa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
.header-sub { color: #6b6b8a; font-size: 12px; margin-top: 3px; }

/* ‚îÄ‚îÄ CONNECTION STATUS ‚îÄ‚îÄ */
.status-indicator {
  display: flex;
  align-items: center;
  gap: 8px;
  background: #1a1a24;
  border: 1px solid #2a2a3a;
  border-radius: 12px;
  padding: 6px 12px;
}
.status-dot { 
  width: 8px; 
  height: 8px; 
  border-radius: 50%; 
  background: #22c55e; 
  box-shadow: 0 0 8px #22c55e; 
}
.status-dot.online { 
  background: #22c55e; 
  box-shadow: 0 0 8px #22c55e; 
  animation: pulse 2s infinite; 
}
.status-dot.offline { 
  background: #ef4444; 
  box-shadow: 0 0 8px #ef4444; 
  animation: none;
}
.status-dot.checking { 
  background: #f59e0b; 
  box-shadow: 0 0 8px #f59e0b;
  animation: pulse 1s infinite;
}
.status-text {
  font-size: 11px;
  font-weight: 700;
  color: #6b6b8a;
}
@keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.4; } }

/* NAV */
.nav {
  position: fixed; bottom: 0; left: 50%; transform: translateX(-50%);
  width: 100%; max-width: 440px;
  background: #1a1a24; border-top: 1px solid #2a2a3a;
  display: flex; justify-content: space-around; padding: 8px 0; z-index: 100;
}
.nav-btn {
  display: flex; flex-direction: column; align-items: center; gap: 3px;
  background: none; border: none; color: #6b6b8a;
  font-family: 'Syne', sans-serif; font-weight: 700; font-size: 10px;
  cursor: pointer; transition: color 0.2s; padding: 4px 16px;
  position: relative;
}
.nav-btn.active { color: #8b84ff; }
.nav-btn .nav-icon { font-size: 20px; }
.notif-badge {
  position: absolute; top: 0; right: 8px;
  background: #ef4444; color: #fff; border-radius: 10px;
  font-size: 10px; font-weight: 800; padding: 1px 5px; min-width: 16px; text-align: center;
  display: none;
}

/* VIEWS */
.view { display: none; padding: 16px 20px; flex: 1; }
.view.active { display: block; }

/* FILTER */
.filter-row { display: flex; gap: 8px; padding: 12px 20px 4px; overflow-x: auto; }
.filter-btn {
  background: #1a1a24; color: #6b6b8a; border: 1px solid #2a2a3a;
  border-radius: 20px; padding: 6px 14px;
  font-family: 'Syne', sans-serif; font-weight: 700; font-size: 12px;
  cursor: pointer; white-space: nowrap; transition: all 0.2s;
}
.filter-btn.active { background: #6c63ff; color: #fff; border-color: #6c63ff; }

/* CARDS */
.card {
  background: #1a1a24; border-radius: 16px; border: 1px solid #2a2a3a;
  padding: 16px; margin-bottom: 12px; transition: border-color 0.2s;
}
.card:hover { border-color: #3a3a4a; }
.card-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
.card-name { font-weight: 800; font-size: 16px; }
.card-phone { color: #6b6b8a; font-size: 13px; margin-top: 2px; }
.badge { display: inline-block; border-radius: 20px; padding: 3px 10px; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
.badge-green { background: #22c55e22; color: #22c55e; }
.badge-yellow { background: #f59e0b22; color: #f59e0b; }
.badge-red { background: #ef444422; color: #ef4444; }
.badge-blue { background: #6c63ff22; color: #6c63ff; }
.card-meta { display: flex; gap: 16px; margin-bottom: 10px; flex-wrap: wrap; }
.card-meta span { color: #8b84ff; font-size: 13px; font-weight: 700; }
.card-note { background: #0d0d14; border-left: 3px solid #6c63ff; border-radius: 0 8px 8px 0; padding: 8px 12px; font-size: 13px; color: #9b9bb8; margin-bottom: 12px; line-height: 1.5; }
.card-actions { display: flex; gap: 8px; flex-wrap: wrap; }
.countdown { font-size: 12px; color: #f59e0b; font-weight: 700; margin-bottom: 10px; }

/* BUTTONS */
.btn { border: none; border-radius: 12px; padding: 9px 16px; font-family: 'Syne', sans-serif; font-weight: 700; font-size: 13px; cursor: pointer; color: #fff; transition: all 0.2s; }
.btn:hover { filter: brightness(1.1); transform: translateY(-1px); }
.btn:active { transform: translateY(0); }
.btn-accent { background: #6c63ff; }
.btn-green { background: #22c55e; }
.btn-red { background: #ef4444; }
.btn-gray { background: #2a2a3a; color: #9b9bb8; }
.btn-full { width: 100%; padding: 14px; font-size: 15px; margin-top: 4px; }

/* FORM */
.form-group { margin-bottom: 16px; }
label { color: #6b6b8a; font-size: 11px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 6px; display: block; }
input, select, textarea {
  width: 100%; background: #0d0d14; border: 1px solid #2a2a3a; border-radius: 12px;
  padding: 12px 14px; color: #f0f0ff; font-family: 'Syne', sans-serif; font-size: 14px; outline: none; transition: border-color 0.2s;
}
input:focus, select:focus, textarea:focus { border-color: #6c63ff; }
select option { background: #1a1a24; }
textarea { resize: vertical; min-height: 70px; }

.info-box { background: #6c63ff11; border: 1px solid #6c63ff33; border-radius: 12px; padding: 12px; margin-bottom: 16px; font-size: 13px; color: #8b84ff; line-height: 1.6; }
.warning-box { background: #f59e0b11; border: 1px solid #f59e0b33; border-radius: 12px; padding: 12px; margin-bottom: 16px; font-size: 13px; color: #f59e0b; line-height: 1.6; }
.error-box { background: #ef444411; border: 1px solid #ef444433; border-radius: 12px; padding: 12px; margin-bottom: 16px; font-size: 13px; color: #ef4444; line-height: 1.6; }

/* TOAST */
.toast {
  position: fixed; top: 16px; left: 50%; transform: translateX(-50%);
  border-radius: 14px; padding: 12px 20px; font-weight: 700; font-size: 13px;
  z-index: 9999; max-width: 360px; text-align: center;
  box-shadow: 0 8px 32px rgba(0,0,0,0.5); color: #fff;
  display: none; animation: slideDown 0.3s ease;
}
@keyframes slideDown { from { opacity: 0; transform: translateX(-50%) translateY(-10px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }
.toast.success { background: #22c55e; }
.toast.error { background: #ef4444; }
.toast.info { background: #6c63ff; }
.toast.warning { background: #f59e0b; }

/* EMPTY */
.empty { text-align: center; padding: 50px 0; color: #6b6b8a; }
.empty-icon { font-size: 48px; margin-bottom: 12px; }
.empty p { font-size: 14px; }

/* NOTIF CARDS */
.notif-card { background: #1a1a24; border-radius: 14px; border: 1px solid #2a2a3a; padding: 14px; margin-bottom: 10px; }
.notif-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
.notif-name { font-weight: 700; font-size: 15px; }
.notif-time { color: #6b6b8a; font-size: 12px; }
.notif-msg { background: #0d0d14; border-radius: 10px; padding: 10px 12px; font-size: 13px; line-height: 1.6; color: #ccc; }

/* SETTINGS */
.settings-item { background: #1a1a24; border: 1px solid #2a2a3a; border-radius: 14px; padding: 16px; margin-bottom: 10px; }
.settings-label { font-size: 12px; color: #6b6b8a; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px; }
.settings-value { font-size: 15px; font-weight: 700; color: #8b84ff; word-break: break-all; }
.settings-desc { font-size: 12px; color: #6b6b8a; margin-top: 4px; line-height: 1.5; }

/* COLLECTOR VIEW */
.collector-header { text-align: center; padding: 30px 20px 20px; }
.collector-icon { font-size: 60px; margin-bottom: 12px; }
.collector-title { font-size: 22px; font-weight: 800; margin-bottom: 8px; }
.collector-sub { color: #6b6b8a; font-size: 14px; line-height: 1.6; }
.upcoming-apt { background: linear-gradient(135deg, #6c63ff22, #a78bfa11); border: 1px solid #6c63ff44; border-radius: 16px; padding: 18px; margin-bottom: 12px; }
.upcoming-apt .apt-title { font-size: 18px; font-weight: 800; margin-bottom: 4px; }
.upcoming-apt .apt-time { color: #8b84ff; font-size: 14px; font-weight: 700; }
.upcoming-apt .apt-countdown { color: #f59e0b; font-size: 13px; margin-top: 8px; font-weight: 700; }

/* QUEUE INDICATOR */
.queue-indicator {
  background: #f59e0b22;
  border: 1px solid #f59e0b33;
  border-radius: 12px;
  padding: 12px;
  margin-bottom: 16px;
  display: none;
  align-items: center;
  gap: 12px;
}
.queue-indicator.show { display: flex; }
.queue-icon { font-size: 24px; }
.queue-text { flex: 1; }
.queue-text strong { color: #f59e0b; font-weight: 700; }
.queue-count { background: #f59e0b; color: #fff; border-radius: 20px; padding: 4px 10px; font-size: 12px; font-weight: 800; }

/* LOADING SPINNER */
.spinner {
  border: 3px solid #2a2a3a;
  border-top: 3px solid #6c63ff;
  border-radius: 50%;
  width: 20px;
  height: 20px;
  animation: spin 0.8s linear infinite;
  display: inline-block;
  vertical-align: middle;
  margin-right: 8px;
}
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>
</head>
<body>
<div class="toast" id="toast"></div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!--          SETUP: ROLLE W√ÑHLEN          -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="setupScreen">
  <div class="setup-logo">üìÖ</div>
  <div class="setup-title">Termin Manager Pro</div>
  <div class="setup-sub">Eure private Termin-App f√ºr das Vertriebsteam.<br>Beide sind Chefs! Wer macht was?</div>

  <div class="setup-card">
    <h3>Rolle ausw√§hlen</h3>
    <button class="role-btn" id="btn-chef">
      <span class="icon">üìù</span>
      <div>
        <div>Termine eintragen</div>
        <div class="desc">Ich erstelle und verwalte Termine</div>
      </div>
    </button>
    <button class="role-btn" id="btn-kollege">
      <span class="icon">üì±</span>
      <div>
        <div>Termine empfangen</div>
        <div class="desc">Ich bin im Vertrieb und bekomme die Termine</div>
      </div>
    </button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!--       CHANNEL EINRICHTEN              -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="channelScreen">
  <div class="channel-card">
    <div class="channel-title" id="channelTitle">‚öôÔ∏è Einrichtung</div>
    <div class="channel-sub" id="channelSub"></div>

    <!-- Chef Setup -->
    <div id="chefSetup" style="display:none">
      <div class="form-group">
        <label>Euer Team-Code (beliebig w√§hlen)</label>
        <input type="text" id="channelInput" placeholder="z.B. mustervertrieb2024">
        <div style="font-size:12px;color:#6b6b8a;margin-top:6px;">Nur Buchstaben, Zahlen, keine Leerzeichen</div>
      </div>
      <div class="info-box" id="channelPreview" style="display:none">
        üì± Dein Partner nutzt den gleichen Code zum Einloggen
      </div>
      <button class="btn btn-accent btn-full" id="btn-save-chef">‚úÖ Weiter</button>
    </div>

    <!-- Kollege Setup -->
    <div id="kollegeSetup" style="display:none">
      <div class="info-box" style="margin-bottom:20px">
        üí° Du brauchst keine externe App! Alles l√§uft direkt hier in der Web-App mit Echtzeit-Updates.
      </div>

      <div class="form-group">
        <label>Team-Code von deinem Partner</label>
        <input type="text" id="kollegeChannelInput" placeholder="z.B. mustervertrieb2024">
      </div>
      <button class="btn btn-accent btn-full" id="btn-save-kollege">‚úÖ Fertig ‚Äì App √∂ffnen</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!--            HAUPT APP                  -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="mainApp">
  <!-- HEADER -->
  <div class="header">
    <div class="header-label" id="roleLabel">Chef Dashboard</div>
    <div class="header-top">
      <div>
        <div class="header-title" id="headerTitle">Termine</div>
        <div class="header-sub" id="headerSub"></div>
      </div>
      <div class="status-indicator">
        <div class="status-dot checking" id="statusDot"></div>
        <div class="status-text" id="statusText">Pr√ºfe...</div>
      </div>
    </div>
  </div>

  <!-- CHEF: Filter + Termine -->
  <div id="chefContent" style="display:none">
    <div class="filter-row">
      <button class="filter-btn active" onclick="setFilter('all', this)">Alle</button>
      <button class="filter-btn" onclick="setFilter('upcoming', this)">üìÖ Anstehend</button>
      <button class="filter-btn" onclick="setFilter('past', this)">‚úÖ Vergangen</button>
    </div>
  </div>

  
  <!-- VIEW: TERMINE (Chef) -->
  <div class="view active" id="view-list">
    <div id="termineList"></div>
  </div>

  <!-- VIEW: NEU (Chef) -->
  <div class="view" id="view-add">
    <div class="card">
      <div class="form-group">
        <label>Kundenname / Firma</label>
        <input type="text" id="inp-name" placeholder="z.B. M√ºller GmbH">
      </div>
      <div class="form-group">
        <label>Telefonnummer (optional)</label>
        <input type="tel" id="inp-phone" placeholder="+49 151 ...">
      </div>
      <div class="form-group">
        <label>Datum</label>
        <input type="date" id="inp-date">
      </div>
      <div class="form-group">
        <label>Uhrzeit</label>
        <input type="time" id="inp-time">
      </div>
      <div class="form-group">
        <label>Notiz / Was zu tun ist</label>
        <textarea id="inp-note" placeholder="z.B. Angebot vorstellen, Vertrag dabei haben..."></textarea>
      </div>
      <div class="form-group">
        <label>Erinnerung vorher</label>
        <select id="inp-reminder">
          <option value="0">Zur genauen Uhrzeit</option>
          <option value="5">5 Minuten vorher</option>
          <option value="15" selected>15 Minuten vorher</option>
          <option value="30">30 Minuten vorher</option>
          <option value="60">1 Stunde vorher</option>
        </select>
      </div>
      <div class="info-box">
        üîî Dein Partner sieht den Termin sofort in Echtzeit in seiner App und bekommt eine Benachrichtigung.
      </div>
      <button class="btn btn-accent btn-full" id="btn-add-termin">üìÖ Termin eintragen & Partner benachrichtigen</button>
    </div>
  </div>

  <!-- VIEW: NACHRICHTEN -->
  <div class="view" id="view-notifications">
    <div id="notifList"></div>
  </div>

  <!-- VIEW: EINSTELLUNGEN -->
  <div class="view" id="view-settings">
    <div class="settings-item">
      <div class="settings-label">Deine Rolle</div>
      <div class="settings-value" id="settingsRole"></div>
    </div>
    <div class="settings-item">
      <div class="settings-label">Team-Code</div>
      <div class="settings-value" id="settingsChannel"></div>
      <div class="settings-desc">Dein Kollege nutzt diesen Code zum Einloggen.</div>
    </div>
    <div class="settings-item">
      <div class="settings-label">Verbindungsstatus</div>
      <div class="settings-value" id="settingsStatus">Pr√ºfe...</div>
      <div class="settings-desc" id="settingsStatusDesc">Verbindung zur Datenbank wird gepr√ºft...</div>
    </div>
    <button class="btn btn-red btn-full" onclick="resetApp()">üîÑ App zur√ºcksetzen</button>
  </div>

  <!-- VIEW: KOLLEGE (Termine sehen) -->
  <div class="view" id="view-kollege">
    <div class="collector-header">
      <div class="collector-icon">üì±</div>
      <div class="collector-title">Hallo Partner!</div>
      <div class="collector-sub">Hier siehst du alle deine Vertriebstermine.</div>
    </div>
    <div id="kollegeTermineList"></div>
  </div>

  <!-- BOTTOM NAV (Chef) -->
  <nav class="nav" id="chefNav" style="display:none">
    <button class="nav-btn active" id="nav-list" onclick="switchView('list')">
      <span class="nav-icon">üìã</span>Termine
    </button>
    <button class="nav-btn" id="nav-add" onclick="switchView('add')">
      <span class="nav-icon">‚ûï</span>Neu
    </button>
    <button class="nav-btn" id="nav-notifications" onclick="switchView('notifications')">
      <span class="nav-icon">üîî</span>
      <span id="navLabel">Verlauf</span>
      <span class="notif-badge" id="notifBadge"></span>
    </button>
    <button class="nav-btn" id="nav-settings" onclick="switchView('settings')">
      <span class="nav-icon">‚öôÔ∏è</span>Einstellungen
    </button>
  </nav>

  <!-- BOTTOM NAV (Kollege) -->
  <nav class="nav" id="kollegeNav" style="display:none">
    <button class="nav-btn active" id="nav-kollege" onclick="switchView('kollege')">
      <span class="nav-icon">üìÖ</span>Meine Termine
    </button>
    <button class="nav-btn" id="nav-settings-k" onclick="switchView('settings')">
      <span class="nav-icon">‚öôÔ∏è</span>Einstellungen
    </button>
  </nav>
</div>

<script type="module">
import { supabase } from '/src/supabase.js';

let role = localStorage.getItem('tm_role');
let channel = localStorage.getItem('tm_channel');
let teamId = localStorage.getItem('tm_team_id');
let termine = [];
let verlauf = [];
let currentFilter = 'all';
let currentView = role === 'kollege' ? 'kollege' : 'list';
let realtimeSubscription = null;
let isOnline = true;

async function updateConnectionStatus() {
  const dot = document.getElementById('statusDot');
  const text = document.getElementById('statusText');
  const settingsStatus = document.getElementById('settingsStatus');
  const settingsStatusDesc = document.getElementById('settingsStatusDesc');

  try {
    const { error } = await supabase.from('teams').select('id').limit(1);

    if (!error) {
      dot.className = 'status-dot online';
      text.textContent = 'Online';
      if (settingsStatus) settingsStatus.textContent = 'üü¢ Verbunden';
      if (settingsStatusDesc) settingsStatusDesc.textContent = 'Verbindung zur Datenbank aktiv. Alle √Ñnderungen werden in Echtzeit synchronisiert.';
      isOnline = true;
    } else {
      throw error;
    }
  } catch (e) {
    dot.className = 'status-dot offline';
    text.textContent = 'Getrennt';
    if (settingsStatus) settingsStatus.textContent = 'üî¥ Verbindungsfehler';
    if (settingsStatusDesc) settingsStatusDesc.textContent = 'Verbindung zur Datenbank fehlgeschlagen. Bitte Internetverbindung pr√ºfen.';
    isOnline = false;
  }
}

async function init() {
  // Setup initial event listeners
  const btnChef = document.getElementById('btn-chef');
  const btnKollege = document.getElementById('btn-kollege');
  
  if (btnChef) btnChef.addEventListener('click', () => chooseRole('chef'));
  if (btnKollege) btnKollege.addEventListener('click', () => chooseRole('kollege'));
  
  if (role && channel && teamId) {
    await startApp();
  } else {
    document.getElementById('setupScreen').style.display = 'flex';
  }
}

function chooseRole(r) {
  role = r;
  document.getElementById('setupScreen').style.display = 'none';
  document.getElementById('channelScreen').style.display = 'flex';

  if (r === 'chef') {
    document.getElementById('channelTitle').textContent = '‚öôÔ∏è Team-Code festlegen';
    document.getElementById('channelSub').textContent = 'W√§hle einen geheimen Code f√ºr euer Team. Dein Partner nutzt diesen Code zum Einloggen.';
    document.getElementById('chefSetup').style.display = 'block';
    document.getElementById('channelInput').addEventListener('input', updateChannelPreview);
    document.getElementById('btn-save-chef').addEventListener('click', saveChefChannel);
  } else {
    document.getElementById('channelTitle').textContent = 'üì± Mit Team verbinden';
    document.getElementById('channelSub').textContent = 'Gib den Team-Code ein, den dir dein Partner geschickt hat.';
    document.getElementById('kollegeSetup').style.display = 'block';
    document.getElementById('kollegeChannelInput').addEventListener('input', updateKollegePreview);
    document.getElementById('btn-save-kollege').addEventListener('click', saveKollegeChannel);
  }
}

function updateChannelPreview() {
  const val = document.getElementById('channelInput').value.trim().replace(/\s+/g, '-');
  if (val.length > 2) {
    document.getElementById('channelPreview').style.display = 'block';
  } else {
    document.getElementById('channelPreview').style.display = 'none';
  }
}

function updateKollegePreview() {
  const val = document.getElementById('kollegeChannelInput').value.trim().replace(/\s+/g, '-');
  // Keine zus√§tzliche Aktion n√∂tig - Button ist immer sichtbar
}

async function saveChefChannel() {
  const val = document.getElementById('channelInput').value.trim().replace(/\s+/g, '-').toLowerCase();
  if (val.length < 3) {
    showToast('Bitte mindestens 3 Zeichen eingeben!', 'error');
    return;
  }

  try {
    let { data: existingTeam, error: selectError } = await supabase
      .from('teams')
      .select('id')
      .eq('channel_code', val)
      .maybeSingle();

    if (selectError && selectError.code !== 'PGRST116') {
      throw selectError;
    }

    if (existingTeam) {
      teamId = existingTeam.id;
    } else {
      const { data: newTeam, error: insertError } = await supabase
        .from('teams')
        .insert({ channel_code: val })
        .select('id')
        .single();

      if (insertError) throw insertError;
      teamId = newTeam.id;
    }

    channel = val;
    role = 'chef';
    localStorage.setItem('tm_role', 'chef');
    localStorage.setItem('tm_channel', channel);
    localStorage.setItem('tm_team_id', teamId);

    await startApp();
  } catch (error) {
    console.error('Fehler beim Team-Setup:', error);
    showToast('Fehler beim Einrichten. Bitte versuche es erneut.', 'error');
  }
}

async function saveKollegeChannel() {
  const val = document.getElementById('kollegeChannelInput').value.trim().replace(/\s+/g, '-').toLowerCase();
  if (val.length < 3) {
    showToast('Bitte den Team-Code eingeben!', 'error');
    return;
  }

  try {
    const { data: team, error } = await supabase
      .from('teams')
      .select('id')
      .eq('channel_code', val)
      .maybeSingle();

    if (error) throw error;

    if (!team) {
      showToast('Team-Code nicht gefunden. Bitte Chef fragen!', 'error');
      return;
    }

    channel = val;
    teamId = team.id;
    role = 'kollege';
    currentView = 'kollege';
    localStorage.setItem('tm_role', 'kollege');
    localStorage.setItem('tm_channel', channel);
    localStorage.setItem('tm_team_id', teamId);

    await startApp();
  } catch (error) {
    console.error('Fehler beim Team-Beitritt:', error);
    showToast('Fehler beim Einloggen. Bitte versuche es erneut.', 'error');
  }
}

async function startApp() {
  document.getElementById('setupScreen').style.display = 'none';
  document.getElementById('channelScreen').style.display = 'none';
  document.getElementById('mainApp').style.display = 'flex';

  if (role === 'chef') {
    document.getElementById('chefContent').style.display = 'block';
    document.getElementById('chefNav').style.display = 'flex';
    document.getElementById('roleLabel').textContent = 'üìù Termin-Manager';
    document.getElementById('settingsRole').textContent = 'Termin-Manager (Termine erstellen)';
  } else {
    document.getElementById('kollegeNav').style.display = 'flex';
    document.getElementById('roleLabel').textContent = 'üì± Vertrieb';
    document.getElementById('settingsRole').textContent = 'Vertrieb (Termine empfangen)';
  }

  document.getElementById('settingsChannel').textContent = channel;

  const today = new Date().toISOString().split('T')[0];
  const dateInput = document.getElementById('inp-date');
  if (dateInput) dateInput.value = today;

  await loadTermine();
  await loadVerlauf();
  setupRealtimeSubscription();

  switchView(currentView);
  updateConnectionStatus();
}

// ‚îÄ‚îÄ‚îÄ VIEWS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function switchView(view) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));

  const el = document.getElementById('view-' + view);
  if (el) el.classList.add('active');

  const navEl = document.getElementById('nav-' + view) || document.getElementById('nav-' + view + '-k');
  if (navEl) navEl.classList.add('active');

  currentView = view;

  const titles = { list: 'Termine', add: 'Neuer Termin', notifications: 'Verlauf', settings: 'Einstellungen', kollege: 'Meine Termine' };
  document.getElementById('headerTitle').textContent = titles[view] || '';

  if (view === 'list') { renderTermine(); updateHeaderSub(); }
  if (view === 'notifications') { renderVerlauf(); }
  if (view === 'kollege') { renderKollegeTermine(); }
  if (view === 'add') { 
    document.getElementById('headerSub').textContent = 'Termin eintragen & Partner benachrichtigen';
    // Setup add termin button listener
    const addBtn = document.getElementById('btn-add-termin');
    if (addBtn) {
      const newBtn = addBtn.cloneNode(true);
      addBtn.parentNode.replaceChild(newBtn, addBtn);
      document.getElementById('btn-add-termin').addEventListener('click', addTermin);
    }
  }
  if (view === 'settings') { updateConnectionStatus(); }
}

function setFilter(f, btn) {
  currentFilter = f;
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderTermine();
}

function updateHeaderSub() {
  const count = termine.length;
  document.getElementById('headerSub').textContent = count + (count === 1 ? ' Termin' : ' Termine') + ' gesamt';
}

function renderTermine() {
  const list = document.getElementById('termineList');
  const now = new Date();
  const filtered = termine.filter(a => {
    if (currentFilter === 'all') return true;
    const aptDate = new Date(a.date + 'T' + a.time);
    if (currentFilter === 'upcoming') return aptDate >= now;
    if (currentFilter === 'past') return aptDate < now;
    return true;
  }).sort((a, b) => new Date(a.date + 'T' + a.time) - new Date(b.date + 'T' + b.time));

  if (filtered.length === 0) {
    list.innerHTML = `<div class="empty"><div class="empty-icon">üì≠</div><p>Keine Termine${currentFilter !== 'all' ? ' in dieser Kategorie' : ''}</p></div>`;
    return;
  }

  list.innerHTML = filtered.map(apt => {
    const aptDate = new Date(apt.date + 'T' + apt.time);
    const isPast = aptDate < now;
    const countdown = getCountdown(aptDate);
    const badgeClass = isPast ? 'badge-red' : 'badge-green';
    const badgeText = isPast ? 'Vergangen' : 'üìÖ Anstehend';

    return `
      <div class="card">
        <div class="card-top">
          <div>
            <div class="card-name">${apt.name}</div>
            ${apt.phone ? `<div class="card-phone">üìû ${apt.phone}</div>` : ''}
          </div>
          <div>
            <span class="badge ${badgeClass}">${badgeText}</span>
          </div>
        </div>
        <div class="card-meta">
          <span>üìÖ ${formatDate(apt.date)}</span>
          <span>üïê ${apt.time} Uhr</span>
        </div>
        ${!isPast ? `<div class="countdown">‚è± ${countdown}</div>` : ''}
        ${apt.note ? `<div class="card-note">üí¨ ${apt.note}</div>` : ''}
        <div class="card-actions">
          <button class="btn btn-gray" onclick="sendNotificationForTermin('${apt.id}')">üîî Nochmal benachrichtigen</button>
          <button class="btn btn-accent" onclick="downloadCalendarEvent('${apt.id}')">üìÖ Zu Kalender</button>
          <button class="btn btn-red" onclick="deleteTermin('${apt.id}')">L√∂schen</button>
        </div>
      </div>
    `;
  }).join('');
  updateHeaderSub();
}

function renderKollegeTermine() {
  const list = document.getElementById('kollegeTermineList');
  const now = new Date();
  const upcoming = termine
    .filter(a => new Date(a.date + 'T' + a.time) >= now)
    .sort((a, b) => new Date(a.date + 'T' + a.time) - new Date(b.date + 'T' + b.time));

  document.getElementById('headerSub').textContent = upcoming.length + ' anstehende Termine';

  if (upcoming.length === 0) {
    list.innerHTML = `<div class="empty"><div class="empty-icon">üéâ</div><p>Keine anstehenden Termine</p></div>`;
    return;
  }

  list.innerHTML = upcoming.map(apt => `
    <div class="upcoming-apt">
      <div class="apt-title">${apt.name}</div>
      <div class="apt-time">üìÖ ${formatDate(apt.date)} ¬∑ üïê ${apt.time} Uhr</div>
      ${apt.phone ? `<div style="color:#6b6b8a;font-size:13px;margin-top:4px;">üìû ${apt.phone}</div>` : ''}
      ${apt.note ? `<div style="color:#9b9bb8;font-size:13px;margin-top:8px;line-height:1.5">üí¨ ${apt.note}</div>` : ''}
      <div class="apt-countdown">‚è± ${getCountdown(new Date(apt.date + 'T' + apt.time))}</div>
    </div>
  `).join('');
}

function renderVerlauf() {
  const list = document.getElementById('notifList');
  document.getElementById('headerSub').textContent = verlauf.length + ' Benachrichtigungen';

  if (verlauf.length === 0) {
    list.innerHTML = `<div class="empty"><div class="empty-icon">üîî</div><p>Noch keine Benachrichtigungen</p></div>`;
    return;
  }

  list.innerHTML = verlauf.map(n => {
    const date = new Date(n.created_at);
    const timeStr = date.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
    const dateStr = date.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' });

    return `
      <div class="notif-card">
        <div class="notif-top">
          <div>
            <span class="badge badge-green">‚úÖ Gesendet</span>
            <span class="notif-name" style="margin-left:8px;">${n.title}</span>
          </div>
          <span class="notif-time">${dateStr} ${timeStr}</span>
        </div>
        <div class="notif-msg">${n.message}</div>
      </div>
    `;
  }).join('');
}

async function loadTermine() {
  try {
    const { data, error } = await supabase
      .from('termine')
      .select('*')
      .eq('team_id', teamId)
      .order('date', { ascending: true })
      .order('time', { ascending: true });

    if (error) throw error;
    termine = data || [];
  } catch (error) {
    console.error('Fehler beim Laden der Termine:', error);
    showToast('Fehler beim Laden der Termine', 'error');
  }
}

async function loadVerlauf() {
  try {
    const { data, error } = await supabase
      .from('notifications')
      .select('*')
      .eq('team_id', teamId)
      .order('created_at', { ascending: false })
      .limit(50);

    if (error) throw error;
    verlauf = data || [];
  } catch (error) {
    console.error('Fehler beim Laden des Verlaufs:', error);
  }
}

function setupRealtimeSubscription() {
  if (realtimeSubscription) {
    supabase.removeChannel(realtimeSubscription);
  }

  realtimeSubscription = supabase
    .channel('team-' + teamId)
    .on('postgres_changes', { event: '*', schema: 'public', table: 'termine', filter: `team_id=eq.${teamId}` }, () => {
      loadTermine().then(() => {
        if (currentView === 'list') renderTermine();
        if (currentView === 'kollege') renderKollegeTermine();
      });
    })
    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'notifications', filter: `team_id=eq.${teamId}` }, async (payload) => {
      if (role === 'kollege' && payload.new) {
        showToast(`üìÖ ${payload.new.title}`, 'info');
        
        // Play notification sound
        try {
          const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBTGH0fPTgjMGHm7A7+OZUQ==');
          audio.volume = 0.3;
          audio.play().catch(() => {}); // Ignore if autoplay blocked
        } catch (e) {}
      }
      await loadVerlauf();
      if (currentView === 'notifications') renderVerlauf();
    })
    .subscribe();
}

async function addTermin() {
  const name = document.getElementById('inp-name').value.trim();
  const phone = document.getElementById('inp-phone').value.trim();
  const date = document.getElementById('inp-date').value;
  const time = document.getElementById('inp-time').value;
  const note = document.getElementById('inp-note').value.trim();
  const reminderMinutes = parseInt(document.getElementById('inp-reminder').value);

  if (!name || !date || !time) {
    showToast('Bitte Name, Datum & Uhrzeit ausf√ºllen!', 'error');
    return;
  }

  try {
    const { data: termin, error: terminError } = await supabase
      .from('termine')
      .insert({
        team_id: teamId,
        name,
        phone,
        date,
        time,
        note,
        reminder_minutes: reminderMinutes,
        status: 'pending',
        created_by: 'chef'
      })
      .select()
      .single();

    if (terminError) throw terminError;

    const message = `üìÖ NEUER TERMIN\n\nKunde: ${name}\nDatum: ${formatDate(date)}\nUhrzeit: ${time} Uhr${phone ? '\nTel: ' + phone : ''}${note ? '\nüìù ' + note : ''}`;

    const { error: notifError } = await supabase
      .from('notifications')
      .insert({
        team_id: teamId,
        termin_id: termin.id,
        title: 'üìÖ Neuer Termin: ' + name,
        message,
        type: 'new_termin'
      });

    if (notifError) throw notifError;
    
    // Auto-download calendar file
    setTimeout(() => {
      downloadCalendarEvent(termin.id);
    }, 500);

    document.getElementById('inp-name').value = '';
    document.getElementById('inp-phone').value = '';
    document.getElementById('inp-time').value = '';
    document.getElementById('inp-note').value = '';

    showToast('‚úÖ Termin eingetragen!', 'success');
    switchView('list');
  } catch (error) {
    console.error('Fehler beim Hinzuf√ºgen:', error);
    showToast('Fehler beim Speichern des Termins', 'error');
  }
}

async function sendNotificationForTermin(terminId) {
  const apt = termine.find(a => a.id === terminId);
  if (!apt) return;

  try {
    const message = `üîî ERINNERUNG\n\nKunde: ${apt.name}\nDatum: ${formatDate(apt.date)}\nUhrzeit: ${apt.time} Uhr${apt.phone ? '\nTel: ' + apt.phone : ''}${apt.note ? '\nüìù ' + apt.note : ''}`;

    const { error } = await supabase
      .from('notifications')
      .insert({
        team_id: teamId,
        termin_id: apt.id,
        title: 'üîî Erinnerung: ' + apt.name,
        message,
        type: 'reminder'
      });

    if (error) throw error;
    showToast('üîî Benachrichtigung gesendet!', 'success');
  } catch (error) {
    console.error('Fehler beim Senden:', error);
    showToast('Fehler beim Senden der Benachrichtigung', 'error');
  }
}

async function confirmTermin(terminId) {
  try {
    const { error } = await supabase
      .from('termine')
      .update({ status: 'confirmed' })
      .eq('id', terminId);

    if (error) throw error;
    showToast('‚úÖ Termin best√§tigt!', 'success');
  } catch (error) {
    console.error('Fehler beim Best√§tigen:', error);
    showToast('Fehler beim Best√§tigen', 'error');
  }
}

async function deleteTermin(terminId) {
  if (!confirm('Termin wirklich l√∂schen?')) return;

  try {
    const { error } = await supabase
      .from('termine')
      .delete()
      .eq('id', terminId);

    if (error) throw error;
    showToast('üóëÔ∏è Termin gel√∂scht', 'info');
  } catch (error) {
    console.error('Fehler beim L√∂schen:', error);
    showToast('Fehler beim L√∂schen', 'error');
  }
}

function downloadCalendarEvent(terminId) {
  const apt = termine.find(a => a.id === terminId);
  if (!apt) return;

  // Create ICS file content
  const startDate = new Date(apt.date + 'T' + apt.time);
  const endDate = new Date(startDate.getTime() + 60 * 60 * 1000); // 1 hour duration
  
  // Format dates for ICS (YYYYMMDDTHHmmss)
  const formatICSDate = (date) => {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    const seconds = String(date.getSeconds()).padStart(2, '0');
    return `${year}${month}${day}T${hours}${minutes}${seconds}`;
  };
  
  const description = `${apt.note || 'Termin'}${apt.phone ? '\\nTel: ' + apt.phone : ''}`.replace(/\n/g, '\\n');
  
  const icsLines = [
    'BEGIN:VCALENDAR',
    'VERSION:2.0',
    'PRODID:-//Termin Manager Pro//DE',
    'CALSCALE:GREGORIAN',
    'METHOD:PUBLISH',
    'BEGIN:VEVENT',
    `DTSTART:${formatICSDate(startDate)}`,
    `DTEND:${formatICSDate(endDate)}`,
    `SUMMARY:${apt.name}`,
    `DESCRIPTION:${description}`,
    `LOCATION:${apt.phone || ''}`,
    `UID:${apt.id}@terminmanager.pro`,
    `DTSTAMP:${formatICSDate(new Date())}`,
    'STATUS:CONFIRMED',
    'SEQUENCE:0'
  ];
  
  if (apt.reminder_minutes) {
    icsLines.push('BEGIN:VALARM');
    icsLines.push(`TRIGGER:-PT${apt.reminder_minutes}M`);
    icsLines.push('ACTION:DISPLAY');
    icsLines.push(`DESCRIPTION:Erinnerung: ${apt.name}`);
    icsLines.push('END:VALARM');
  }
  
  icsLines.push('END:VEVENT');
  icsLines.push('END:VCALENDAR');
  
  const icsContent = icsLines.join('\r\n');
  
  // Create download
  const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `termin-${apt.name.replace(/[^a-z0-9]/gi, '-').toLowerCase()}.ics`;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(link.href);
  
  showToast('üìÖ Kalender-Datei heruntergeladen!', 'success');
}

// ‚îÄ‚îÄ‚îÄ HILFSFUNKTIONEN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function formatDate(dateStr) {
  const d = new Date(dateStr + 'T12:00:00');
  return d.toLocaleDateString('de-DE', { weekday: 'short', day: '2-digit', month: '2-digit', year: 'numeric' });
}

function getCountdown(date) {
  const diff = date - new Date();
  if (diff < 0) return 'Vergangen';
  const h = Math.floor(diff / 3600000);
  const m = Math.floor((diff % 3600000) / 60000);
  if (h > 24) return Math.floor(h / 24) + ' Tage';
  if (h > 0) return h + 'h ' + m + 'min';
  if (m > 0) return m + ' Minuten';
  return 'Jetzt!';
}


function showToast(msg, type = 'success') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'toast ' + type;
  t.style.display = 'block';
  setTimeout(() => t.style.display = 'none', 4000);
}


function resetApp() {
  if (!confirm('App wirklich zur√ºcksetzen? Alle Daten werden gel√∂scht.')) return;
  localStorage.clear();
  location.reload();
}

window.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
