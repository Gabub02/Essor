<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Termin Manager</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  background: #0d0d14;
  color: #f0f0ff;
  font-family: 'Syne', sans-serif;
  min-height: 100vh;
  display: flex;
  justify-content: center;
}
.app {
  width: 100%;
  max-width: 440px;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  padding-bottom: 80px;
}

/* â”€â”€ SETUP SCREEN â”€â”€ */
#setupScreen {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 100vh;
  padding: 30px 24px;
  text-align: center;
}
.setup-logo { font-size: 56px; margin-bottom: 16px; }
.setup-title { font-size: 28px; font-weight: 800; background: linear-gradient(135deg, #8b84ff, #a78bfa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 8px; }
.setup-sub { color: #6b6b8a; font-size: 14px; margin-bottom: 32px; line-height: 1.6; }
.setup-card { background: #1a1a24; border: 1px solid #2a2a3a; border-radius: 20px; padding: 24px; width: 100%; margin-bottom: 16px; text-align: left; }
.setup-card h3 { font-size: 14px; color: #8b84ff; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 16px; }
.role-btn {
  width: 100%;
  padding: 16px;
  border-radius: 14px;
  border: 2px solid #2a2a3a;
  background: #0d0d14;
  color: #f0f0ff;
  font-family: 'Syne', sans-serif;
  font-size: 16px;
  font-weight: 700;
  cursor: pointer;
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  gap: 14px;
  transition: all 0.2s;
}
.role-btn:hover { border-color: #6c63ff; background: #6c63ff11; }
.role-btn .icon { font-size: 28px; }
.role-btn .desc { font-size: 12px; color: #6b6b8a; font-weight: 400; margin-top: 2px; }

/* â”€â”€ CHANNEL SETUP â”€â”€ */
#channelScreen {
  display: none;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 100vh;
  padding: 30px 24px;
}
.channel-card { background: #1a1a24; border: 1px solid #2a2a3a; border-radius: 20px; padding: 24px; width: 100%; }
.channel-title { font-size: 22px; font-weight: 800; margin-bottom: 8px; }
.channel-sub { color: #6b6b8a; font-size: 13px; margin-bottom: 24px; line-height: 1.6; }
.steps { margin-bottom: 24px; }
.step { display: flex; gap: 14px; align-items: flex-start; margin-bottom: 16px; }
.step-num { background: #6c63ff; color: #fff; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 13px; flex-shrink: 0; margin-top: 2px; }
.step-text { font-size: 14px; line-height: 1.6; color: #ccc; }
.step-text strong { color: #f0f0ff; }
.channel-display { background: #0d0d14; border: 2px solid #6c63ff; border-radius: 12px; padding: 14px 16px; font-size: 18px; font-weight: 800; color: #8b84ff; letter-spacing: 2px; text-align: center; margin-bottom: 16px; word-break: break-all; }

/* â”€â”€ MAIN APP â”€â”€ */
#mainApp { display: none; flex-direction: column; flex: 1; }

.header {
  padding: 20px 20px 14px;
  background: linear-gradient(180deg, #1a1a24 0%, #0d0d14 100%);
  border-bottom: 1px solid #2a2a3a;
}
.header-top { display: flex; justify-content: space-between; align-items: center; }
.header-label { font-size: 11px; color: #6b6b8a; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 4px; }
.header-title { font-size: 24px; font-weight: 800; background: linear-gradient(135deg, #8b84ff, #a78bfa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
.header-sub { color: #6b6b8a; font-size: 12px; margin-top: 3px; }
.status-dot { width: 10px; height: 10px; border-radius: 50%; background: #22c55e; box-shadow: 0 0 8px #22c55e; animation: pulse 2s infinite; }
@keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.4; } }

/* NAV */
.nav {
  position: fixed; bottom: 0; left: 50%; transform: translateX(-50%);
  width: 100%; max-width: 440px;
  background: #1a1a24; border-top: 1px solid #2a2a3a;
  display: flex; justify-content: space-around; padding: 8px 0; z-index: 100;
}
.nav-btn {
  display: flex; flex-direction: column; align-items: center; gap: 3px;
  background: none; border: none; color: #6b6b8a;
  font-family: 'Syne', sans-serif; font-weight: 700; font-size: 10px;
  cursor: pointer; transition: color 0.2s; padding: 4px 16px;
  position: relative;
}
.nav-btn.active { color: #8b84ff; }
.nav-btn .nav-icon { font-size: 20px; }
.notif-badge {
  position: absolute; top: 0; right: 8px;
  background: #ef4444; color: #fff; border-radius: 10px;
  font-size: 10px; font-weight: 800; padding: 1px 5px; min-width: 16px; text-align: center;
  display: none;
}

/* VIEWS */
.view { display: none; padding: 16px 20px; flex: 1; }
.view.active { display: block; }

/* FILTER */
.filter-row { display: flex; gap: 8px; padding: 12px 20px 4px; overflow-x: auto; }
.filter-btn {
  background: #1a1a24; color: #6b6b8a; border: 1px solid #2a2a3a;
  border-radius: 20px; padding: 6px 14px;
  font-family: 'Syne', sans-serif; font-weight: 700; font-size: 12px;
  cursor: pointer; white-space: nowrap; transition: all 0.2s;
}
.filter-btn.active { background: #6c63ff; color: #fff; border-color: #6c63ff; }

/* CARDS */
.card {
  background: #1a1a24; border-radius: 16px; border: 1px solid #2a2a3a;
  padding: 16px; margin-bottom: 12px; transition: border-color 0.2s;
}
.card:hover { border-color: #3a3a4a; }
.card-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
.card-name { font-weight: 800; font-size: 16px; }
.card-phone { color: #6b6b8a; font-size: 13px; margin-top: 2px; }
.badge { display: inline-block; border-radius: 20px; padding: 3px 10px; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
.badge-green { background: #22c55e22; color: #22c55e; }
.badge-yellow { background: #f59e0b22; color: #f59e0b; }
.badge-red { background: #ef444422; color: #ef4444; }
.card-meta { display: flex; gap: 16px; margin-bottom: 10px; flex-wrap: wrap; }
.card-meta span { color: #8b84ff; font-size: 13px; font-weight: 700; }
.card-note { background: #0d0d14; border-left: 3px solid #6c63ff; border-radius: 0 8px 8px 0; padding: 8px 12px; font-size: 13px; color: #9b9bb8; margin-bottom: 12px; line-height: 1.5; }
.card-actions { display: flex; gap: 8px; flex-wrap: wrap; }
.countdown { font-size: 12px; color: #f59e0b; font-weight: 700; margin-bottom: 10px; }

/* BUTTONS */
.btn { border: none; border-radius: 12px; padding: 9px 16px; font-family: 'Syne', sans-serif; font-weight: 700; font-size: 13px; cursor: pointer; color: #fff; transition: all 0.2s; }
.btn:hover { filter: brightness(1.1); transform: translateY(-1px); }
.btn:active { transform: translateY(0); }
.btn-accent { background: #6c63ff; }
.btn-green { background: #22c55e; }
.btn-red { background: #ef4444; }
.btn-gray { background: #2a2a3a; color: #9b9bb8; }
.btn-full { width: 100%; padding: 14px; font-size: 15px; margin-top: 4px; }

/* FORM */
.form-group { margin-bottom: 16px; }
label { color: #6b6b8a; font-size: 11px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 6px; display: block; }
input, select, textarea {
  width: 100%; background: #0d0d14; border: 1px solid #2a2a3a; border-radius: 12px;
  padding: 12px 14px; color: #f0f0ff; font-family: 'Syne', sans-serif; font-size: 14px; outline: none; transition: border-color 0.2s;
}
input:focus, select:focus, textarea:focus { border-color: #6c63ff; }
select option { background: #1a1a24; }
textarea { resize: vertical; min-height: 70px; }

.info-box { background: #6c63ff11; border: 1px solid #6c63ff33; border-radius: 12px; padding: 12px; margin-bottom: 16px; font-size: 13px; color: #8b84ff; line-height: 1.6; }
.warning-box { background: #f59e0b11; border: 1px solid #f59e0b33; border-radius: 12px; padding: 12px; margin-bottom: 16px; font-size: 13px; color: #f59e0b; line-height: 1.6; }

/* TOAST */
.toast {
  position: fixed; top: 16px; left: 50%; transform: translateX(-50%);
  border-radius: 14px; padding: 12px 20px; font-weight: 700; font-size: 13px;
  z-index: 9999; max-width: 360px; text-align: center;
  box-shadow: 0 8px 32px rgba(0,0,0,0.5); color: #fff;
  display: none; animation: slideDown 0.3s ease;
}
@keyframes slideDown { from { opacity: 0; transform: translateX(-50%) translateY(-10px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }
.toast.success { background: #22c55e; }
.toast.error { background: #ef4444; }
.toast.info { background: #6c63ff; }
.toast.warning { background: #f59e0b; }

/* EMPTY */
.empty { text-align: center; padding: 50px 0; color: #6b6b8a; }
.empty-icon { font-size: 48px; margin-bottom: 12px; }
.empty p { font-size: 14px; }

/* NOTIF CARDS */
.notif-card { background: #1a1a24; border-radius: 14px; border: 1px solid #2a2a3a; padding: 14px; margin-bottom: 10px; }
.notif-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
.notif-name { font-weight: 700; font-size: 15px; }
.notif-time { color: #6b6b8a; font-size: 12px; }
.notif-msg { background: #0d0d14; border-radius: 10px; padding: 10px 12px; font-size: 13px; line-height: 1.6; color: #ccc; }

/* SETTINGS */
.settings-item { background: #1a1a24; border: 1px solid #2a2a3a; border-radius: 14px; padding: 16px; margin-bottom: 10px; }
.settings-label { font-size: 12px; color: #6b6b8a; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px; }
.settings-value { font-size: 15px; font-weight: 700; color: #8b84ff; word-break: break-all; }
.settings-desc { font-size: 12px; color: #6b6b8a; margin-top: 4px; line-height: 1.5; }

/* COLLECTOR VIEW */
.collector-header { text-align: center; padding: 30px 20px 20px; }
.collector-icon { font-size: 60px; margin-bottom: 12px; }
.collector-title { font-size: 22px; font-weight: 800; margin-bottom: 8px; }
.collector-sub { color: #6b6b8a; font-size: 14px; line-height: 1.6; }
.upcoming-apt { background: linear-gradient(135deg, #6c63ff22, #a78bfa11); border: 1px solid #6c63ff44; border-radius: 16px; padding: 18px; margin-bottom: 12px; }
.upcoming-apt .apt-title { font-size: 18px; font-weight: 800; margin-bottom: 4px; }
.upcoming-apt .apt-time { color: #8b84ff; font-size: 14px; font-weight: 700; }
.upcoming-apt .apt-countdown { color: #f59e0b; font-size: 13px; margin-top: 8px; font-weight: 700; }
</style>
</head>
<body>
<div class="toast" id="toast"></div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!--          SETUP: ROLLE WÃ„HLEN          -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="setupScreen">
  <div class="setup-logo">ğŸ“…</div>
  <div class="setup-title">Termin Manager</div>
  <div class="setup-sub">Eure private Termin-App fÃ¼r das Vertriebsteam.<br>Wer bist du?</div>

  <div class="setup-card">
    <h3>Rolle auswÃ¤hlen</h3>
    <button class="role-btn" onclick="chooseRole('chef')">
      <span class="icon">ğŸ‘¨â€ğŸ’¼</span>
      <div>
        <div>Ich bin der Chef</div>
        <div class="desc">Ich trage Termine ein</div>
      </div>
    </button>
    <button class="role-btn" onclick="chooseRole('kollege')">
      <span class="icon">ğŸ¤</span>
      <div>
        <div>Ich bin der Kollege</div>
        <div class="desc">Ich bekomme Benachrichtigungen</div>
      </div>
    </button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!--       CHANNEL EINRICHTEN              -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="channelScreen">
  <div class="channel-card">
    <div class="channel-title" id="channelTitle">âš™ï¸ Einrichtung</div>
    <div class="channel-sub" id="channelSub"></div>

    <!-- Chef Setup -->
    <div id="chefSetup" style="display:none">
      <div class="form-group">
        <label>Euer Team-Code (beliebig wÃ¤hlen)</label>
        <input type="text" id="channelInput" placeholder="z.B. mustervertrieb2024" oninput="updateChannelPreview()">
        <div style="font-size:12px;color:#6b6b8a;margin-top:6px;">Nur Buchstaben, Zahlen, keine Leerzeichen</div>
      </div>
      <div class="info-box" id="channelPreview" style="display:none">
        ğŸ“± Dein Kollege abonniert: <strong id="channelPreviewText"></strong>
      </div>
      <button class="btn btn-accent btn-full" onclick="saveChefChannel()">âœ… Weiter</button>
    </div>

    <!-- Kollege Setup -->
    <div id="kollegeSetup" style="display:none">
      <div class="steps">
        <div class="step">
          <div class="step-num">1</div>
          <div class="step-text">Lade die kostenlose App <strong>ntfy</strong> auf dein Handy herunter (App Store / Play Store)</div>
        </div>
        <div class="step">
          <div class="step-num">2</div>
          <div class="step-text">Ã–ffne ntfy und tippe auf <strong>"+"</strong> unten rechts</div>
        </div>
        <div class="step">
          <div class="step-num">3</div>
          <div class="step-text">Gib diesen Code ein und abonniere:</div>
        </div>
      </div>

      <div class="form-group">
        <label>Team-Code von deinem Chef</label>
        <input type="text" id="kollegeChannelInput" placeholder="z.B. mustervertrieb2024" oninput="updateKollegePreview()">
      </div>
      <div class="channel-display" id="kollegeChannelDisplay" style="display:none"></div>
      <button class="btn btn-accent btn-full" id="kollegeWeiterBtn" onclick="saveKollegeChannel()" style="display:none">âœ… Fertig â€“ App Ã¶ffnen</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!--            HAUPT APP                  -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="mainApp">
  <!-- HEADER -->
  <div class="header">
    <div class="header-label" id="roleLabel">Chef Dashboard</div>
    <div class="header-top">
      <div>
        <div class="header-title" id="headerTitle">Termine</div>
        <div class="header-sub" id="headerSub"></div>
      </div>
      <div class="status-dot" title="Verbunden"></div>
    </div>
  </div>

  <!-- CHEF: Filter + Termine -->
  <div id="chefContent" style="display:none">
    <div class="filter-row">
      <button class="filter-btn active" onclick="setFilter('all', this)">Alle</button>
      <button class="filter-btn" onclick="setFilter('pending', this)">â³ Offen</button>
      <button class="filter-btn" onclick="setFilter('confirmed', this)">âœ… BestÃ¤tigt</button>
    </div>
  </div>

  <!-- VIEW: TERMINE (Chef) -->
  <div class="view active" id="view-list">
    <div id="termineList"></div>
  </div>

  <!-- VIEW: NEU (Chef) -->
  <div class="view" id="view-add">
    <div class="card">
      <div class="form-group">
        <label>Kundenname / Firma</label>
        <input type="text" id="inp-name" placeholder="z.B. MÃ¼ller GmbH">
      </div>
      <div class="form-group">
        <label>Telefonnummer (optional)</label>
        <input type="tel" id="inp-phone" placeholder="+49 151 ...">
      </div>
      <div class="form-group">
        <label>Datum</label>
        <input type="date" id="inp-date">
      </div>
      <div class="form-group">
        <label>Uhrzeit</label>
        <input type="time" id="inp-time">
      </div>
      <div class="form-group">
        <label>Notiz / Was zu tun ist</label>
        <textarea id="inp-note" placeholder="z.B. Angebot vorstellen, Vertrag dabei haben..."></textarea>
      </div>
      <div class="form-group">
        <label>Erinnerung vorher</label>
        <select id="inp-reminder">
          <option value="0">Zur genauen Uhrzeit</option>
          <option value="5">5 Minuten vorher</option>
          <option value="15" selected>15 Minuten vorher</option>
          <option value="30">30 Minuten vorher</option>
          <option value="60">1 Stunde vorher</option>
        </select>
      </div>
      <div class="info-box">
        ğŸ”” Dein Kollege bekommt sofort eine Benachrichtigung auf sein Handy + eine Erinnerung zur richtigen Zeit.
      </div>
      <button class="btn btn-accent btn-full" onclick="addTermin()">ğŸ“… Termin eintragen & Kollegen benachrichtigen</button>
    </div>
  </div>

  <!-- VIEW: NACHRICHTEN -->
  <div class="view" id="view-notifications">
    <div id="notifList"></div>
  </div>

  <!-- VIEW: EINSTELLUNGEN -->
  <div class="view" id="view-settings">
    <div class="settings-item">
      <div class="settings-label">Deine Rolle</div>
      <div class="settings-value" id="settingsRole"></div>
    </div>
    <div class="settings-item">
      <div class="settings-label">Team-Code (ntfy Kanal)</div>
      <div class="settings-value" id="settingsChannel"></div>
      <div class="settings-desc">Dein Kollege muss diesen Code in der ntfy App abonnieren.</div>
    </div>
    <div class="settings-item">
      <div class="settings-label">ntfy App</div>
      <div class="settings-desc">ğŸ“± <strong>Android:</strong> Play Store â†’ "ntfy" suchen<br>ğŸ <strong>iPhone:</strong> App Store â†’ "ntfy" suchen<br><br>Dann "+" â†’ diesen Code eingeben â†’ abonnieren</div>
    </div>
    <button class="btn btn-red btn-full" onclick="resetApp()" style="margin-top:8px">ğŸ”„ App zurÃ¼cksetzen</button>
  </div>

  <!-- VIEW: KOLLEGE (Termine sehen) -->
  <div class="view" id="view-kollege">
    <div class="collector-header">
      <div class="collector-icon">ğŸ¤</div>
      <div class="collector-title">Hallo Kollege!</div>
      <div class="collector-sub">Hier siehst du alle deine anstehenden Termine.</div>
    </div>
    <div id="kollegeTermineList"></div>
  </div>

  <!-- BOTTOM NAV (Chef) -->
  <nav class="nav" id="chefNav" style="display:none">
    <button class="nav-btn active" id="nav-list" onclick="switchView('list')">
      <span class="nav-icon">ğŸ“‹</span>Termine
    </button>
    <button class="nav-btn" id="nav-add" onclick="switchView('add')">
      <span class="nav-icon">â•</span>Neu
    </button>
    <button class="nav-btn" id="nav-notifications" onclick="switchView('notifications')">
      <span class="nav-icon">ğŸ””</span>
      <span id="navLabel">Verlauf</span>
      <span class="notif-badge" id="notifBadge"></span>
    </button>
    <button class="nav-btn" id="nav-settings" onclick="switchView('settings')">
      <span class="nav-icon">âš™ï¸</span>Einstellungen
    </button>
  </nav>

  <!-- BOTTOM NAV (Kollege) -->
  <nav class="nav" id="kollegeNav" style="display:none">
    <button class="nav-btn active" id="nav-kollege" onclick="switchView('kollege')">
      <span class="nav-icon">ğŸ“…</span>Meine Termine
    </button>
    <button class="nav-btn" id="nav-settings-k" onclick="switchView('settings')">
      <span class="nav-icon">âš™ï¸</span>Einstellungen
    </button>
  </nav>
</div>

<script>
// â”€â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let role = localStorage.getItem('tm_role');
let channel = localStorage.getItem('tm_channel');
let termine = JSON.parse(localStorage.getItem('tm_termine') || '[]');
let verlauf = JSON.parse(localStorage.getItem('tm_verlauf') || '[]');
let currentFilter = 'all';
let currentView = role === 'kollege' ? 'kollege' : 'list';
let reminderTimers = {};

// â”€â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function init() {
  if (role && channel) {
    startApp();
  } else {
    document.getElementById('setupScreen').style.display = 'flex';
  }
  scheduleAllReminders();
}

function chooseRole(r) {
  role = r;
  document.getElementById('setupScreen').style.display = 'none';
  document.getElementById('channelScreen').style.display = 'flex';

  if (r === 'chef') {
    document.getElementById('channelTitle').textContent = 'âš™ï¸ Team-Code festlegen';
    document.getElementById('channelSub').textContent = 'WÃ¤hle einen geheimen Code fÃ¼r euer Team. Deinen Kollegen musst du diesen Code einmal mitteilen.';
    document.getElementById('chefSetup').style.display = 'block';
  } else {
    document.getElementById('channelTitle').textContent = 'ğŸ“± Benachrichtigungen einrichten';
    document.getElementById('channelSub').textContent = 'Installiere die kostenlose ntfy App und gib den Team-Code ein, den dir dein Chef geschickt hat.';
    document.getElementById('kollegeSetup').style.display = 'block';
  }
}

function updateChannelPreview() {
  const val = document.getElementById('channelInput').value.trim().replace(/\s+/g, '-');
  if (val.length > 2) {
    document.getElementById('channelPreview').style.display = 'block';
    document.getElementById('channelPreviewText').textContent = val;
  }
}

function updateKollegePreview() {
  const val = document.getElementById('kollegeChannelInput').value.trim().replace(/\s+/g, '-');
  if (val.length > 2) {
    document.getElementById('kollegeChannelDisplay').style.display = 'block';
    document.getElementById('kollegeChannelDisplay').textContent = val;
    document.getElementById('kollegeWeiterBtn').style.display = 'block';
  }
}

function saveChefChannel() {
  const val = document.getElementById('channelInput').value.trim().replace(/\s+/g, '-');
  if (val.length < 3) { showToast('Bitte mindestens 3 Zeichen eingeben!', 'error'); return; }
  channel = val;
  localStorage.setItem('tm_role', 'chef');
  localStorage.setItem('tm_channel', channel);
  role = 'chef';
  startApp();
}

function saveKollegeChannel() {
  const val = document.getElementById('kollegeChannelInput').value.trim().replace(/\s+/g, '-');
  if (val.length < 3) { showToast('Bitte den Team-Code eingeben!', 'error'); return; }
  channel = val;
  localStorage.setItem('tm_role', 'kollege');
  localStorage.setItem('tm_channel', channel);
  role = 'kollege';
  currentView = 'kollege';
  startApp();
}

function startApp() {
  document.getElementById('setupScreen').style.display = 'none';
  document.getElementById('channelScreen').style.display = 'none';
  document.getElementById('mainApp').style.display = 'flex';

  if (role === 'chef') {
    document.getElementById('chefContent').style.display = 'block';
    document.getElementById('chefNav').style.display = 'flex';
    document.getElementById('roleLabel').textContent = 'ğŸ‘¨â€ğŸ’¼ Chef Dashboard';
    document.getElementById('settingsRole').textContent = 'Chef (Termine eintragen)';
  } else {
    document.getElementById('kollegeNav').style.display = 'flex';
    document.getElementById('roleLabel').textContent = 'ğŸ¤ Kollege';
    document.getElementById('settingsRole').textContent = 'Kollege (Termine empfangen)';
  }

  document.getElementById('settingsChannel').textContent = channel;

  // Set today as default date
  const today = new Date().toISOString().split('T')[0];
  const dateInput = document.getElementById('inp-date');
  if (dateInput) dateInput.value = today;

  switchView(currentView);
  scheduleAllReminders();
  setInterval(updateCountdowns, 30000);
}

// â”€â”€â”€ VIEWS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchView(view) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));

  const el = document.getElementById('view-' + view);
  if (el) el.classList.add('active');

  const navEl = document.getElementById('nav-' + view) || document.getElementById('nav-' + view + '-k');
  if (navEl) navEl.classList.add('active');

  currentView = view;

  const titles = { list: 'Termine', add: 'Neuer Termin', notifications: 'Verlauf', settings: 'Einstellungen', kollege: 'Meine Termine' };
  document.getElementById('headerTitle').textContent = titles[view] || '';

  if (view === 'list') { renderTermine(); updateHeaderSub(); }
  if (view === 'notifications') { renderVerlauf(); }
  if (view === 'kollege') { renderKollegeTermine(); }
  if (view === 'add') { document.getElementById('headerSub').textContent = 'Termin eintragen & Kollegen benachrichtigen'; }
}

function setFilter(f, btn) {
  currentFilter = f;
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderTermine();
}

function updateHeaderSub() {
  const count = termine.length;
  document.getElementById('headerSub').textContent = count + (count === 1 ? ' Termin' : ' Termine') + ' gesamt';
}

// â”€â”€â”€ TERMINE RENDERN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTermine() {
  const list = document.getElementById('termineList');
  const now = new Date();
  const filtered = termine.filter(a => {
    if (currentFilter === 'all') return true;
    return a.status === currentFilter;
  }).sort((a, b) => new Date(a.date + 'T' + a.time) - new Date(b.date + 'T' + b.time));

  if (filtered.length === 0) {
    list.innerHTML = `<div class="empty"><div class="empty-icon">ğŸ“­</div><p>Keine Termine${currentFilter !== 'all' ? ' in dieser Kategorie' : ''}</p></div>`;
    return;
  }

  list.innerHTML = filtered.map(apt => {
    const aptDate = new Date(apt.date + 'T' + apt.time);
    const isPast = aptDate < now;
    const countdown = getCountdown(aptDate);
    const badgeClass = apt.status === 'confirmed' ? 'badge-green' : isPast ? 'badge-red' : 'badge-yellow';
    const badgeText = apt.status === 'confirmed' ? 'âœ“ BestÃ¤tigt' : isPast ? 'Vergangen' : 'â³ Ausstehend';

    return `
      <div class="card">
        <div class="card-top">
          <div>
            <div class="card-name">${apt.name}</div>
            ${apt.phone ? `<div class="card-phone">ğŸ“ ${apt.phone}</div>` : ''}
          </div>
          <span class="badge ${badgeClass}">${badgeText}</span>
        </div>
        <div class="card-meta">
          <span>ğŸ“… ${formatDate(apt.date)}</span>
          <span>ğŸ• ${apt.time} Uhr</span>
        </div>
        ${!isPast && apt.status !== 'confirmed' ? `<div class="countdown">â± ${countdown}</div>` : ''}
        ${apt.note ? `<div class="card-note">ğŸ’¬ ${apt.note}</div>` : ''}
        <div class="card-actions">
          ${apt.status !== 'confirmed' && !isPast ? `<button class="btn btn-green" onclick="confirmTermin(${apt.id})">âœ“ BestÃ¤tigen</button>` : ''}
          <button class="btn btn-gray" onclick="notifyAgain(${apt.id})">ğŸ”” Nochmal senden</button>
          <button class="btn btn-red" onclick="deleteTermin(${apt.id})">LÃ¶schen</button>
        </div>
      </div>
    `;
  }).join('');
  updateHeaderSub();
}

function renderKollegeTermine() {
  const list = document.getElementById('kollegeTermineList');
  const now = new Date();
  const upcoming = termine
    .filter(a => new Date(a.date + 'T' + a.time) >= now)
    .sort((a, b) => new Date(a.date + 'T' + a.time) - new Date(b.date + 'T' + b.time));

  document.getElementById('headerSub').textContent = upcoming.length + ' anstehende Termine';

  if (upcoming.length === 0) {
    list.innerHTML = `<div class="empty"><div class="empty-icon">ğŸ‰</div><p>Keine anstehenden Termine</p></div>`;
    return;
  }

  list.innerHTML = upcoming.map(apt => `
    <div class="upcoming-apt">
      <div class="apt-title">${apt.name}</div>
      <div class="apt-time">ğŸ“… ${formatDate(apt.date)} Â· ğŸ• ${apt.time} Uhr</div>
      ${apt.phone ? `<div style="color:#6b6b8a;font-size:13px;margin-top:4px;">ğŸ“ ${apt.phone}</div>` : ''}
      ${apt.note ? `<div style="color:#9b9bb8;font-size:13px;margin-top:8px;line-height:1.5">ğŸ’¬ ${apt.note}</div>` : ''}
      <div class="apt-countdown">â± ${getCountdown(new Date(apt.date + 'T' + apt.time))}</div>
    </div>
  `).join('');
}

function renderVerlauf() {
  const list = document.getElementById('notifList');
  document.getElementById('headerSub').textContent = verlauf.length + ' gesendete Nachrichten';

  if (verlauf.length === 0) {
    list.innerHTML = `<div class="empty"><div class="empty-icon">ğŸ””</div><p>Noch keine Nachrichten gesendet</p></div>`;
    return;
  }

  list.innerHTML = verlauf.map(n => `
    <div class="notif-card">
      <div class="notif-top">
        <div>
          <span class="badge badge-green" style="margin-right:8px">ğŸ”” Gesendet</span>
          <span class="notif-name">${n.to}</span>
        </div>
        <span class="notif-time">${n.time}</span>
      </div>
      <div class="notif-msg">${n.msg}</div>
    </div>
  `).join('');
}

// â”€â”€â”€ TERMIN HINZUFÃœGEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function addTermin() {
  const name = document.getElementById('inp-name').value.trim();
  const phone = document.getElementById('inp-phone').value.trim();
  const date = document.getElementById('inp-date').value;
  const time = document.getElementById('inp-time').value;
  const note = document.getElementById('inp-note').value.trim();
  const reminder = parseInt(document.getElementById('inp-reminder').value);

  if (!name || !date || !time) {
    showToast('Bitte Name, Datum & Uhrzeit ausfÃ¼llen!', 'error');
    return;
  }

  const newApt = { id: Date.now(), name, phone, date, time, note, reminder, status: 'pending' };
  termine.push(newApt);
  saveTermine();

  const sofortMsg = `ğŸ“… NEUER TERMIN\n\nKunde: ${name}\nDatum: ${formatDate(date)}\nUhrzeit: ${time} Uhr${phone ? '\nTel: ' + phone : ''}${note ? '\nğŸ“ ' + note : ''}`;

  const sent = await sendNotification(sofortMsg, 'ğŸ“… Neuer Termin: ' + name);

  const now = new Date().toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
  verlauf.unshift({ id: Date.now(), to: name, msg: sofortMsg.replace(/\n/g, ' '), time: now });
  saveVerlauf();

  scheduleReminder(newApt);

  document.getElementById('inp-name').value = '';
  document.getElementById('inp-phone').value = '';
  document.getElementById('inp-time').value = '';
  document.getElementById('inp-note').value = '';

  if (sent) {
    showToast('âœ… Termin eingetragen & Kollege benachrichtigt!', 'success');
  } else {
    showToast('âš ï¸ Termin gespeichert. Benachrichtigung fehlgeschlagen â€“ prÃ¼fe Internetverbindung.', 'warning');
  }

  switchView('list');
}

async function notifyAgain(id) {
  const apt = termine.find(a => a.id === id);
  if (!apt) return;
  const msg = `ğŸ”” ERINNERUNG\n\nKunde: ${apt.name}\nDatum: ${formatDate(apt.date)}\nUhrzeit: ${apt.time} Uhr${apt.phone ? '\nTel: ' + apt.phone : ''}${apt.note ? '\nğŸ“ ' + apt.note : ''}`;
  const sent = await sendNotification(msg, 'ğŸ”” Erinnerung: ' + apt.name);
  if (sent) showToast('ğŸ”” Erinnerung gesendet!', 'info');
  else showToast('âŒ Fehler beim Senden. Internet ok?', 'error');
}

function confirmTermin(id) {
  termine = termine.map(a => a.id === id ? { ...a, status: 'confirmed' } : a);
  saveTermine();
  showToast('âœ… Termin bestÃ¤tigt!', 'success');
  renderTermine();
}

function deleteTermin(id) {
  const apt = termine.find(a => a.id === id);
  if (!apt) return;
  if (reminderTimers[id]) { clearTimeout(reminderTimers[id]); delete reminderTimers[id]; }
  termine = termine.filter(a => a.id !== id);
  saveTermine();
  showToast('ğŸ—‘ï¸ Termin gelÃ¶scht.', 'info');
  renderTermine();
}

// â”€â”€â”€ BENACHRICHTIGUNG SENDEN (ntfy) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function sendNotification(message, title) {
  try {
    const response = await fetch('https://ntfy.sh/' + encodeURIComponent(channel), {
      method: 'POST',
      headers: {
        'Title': title,
        'Priority': 'high',
        'Tags': 'calendar,briefcase',
        'Content-Type': 'text/plain; charset=utf-8',
      },
      body: message
    });
    return response.ok;
  } catch (e) {
    console.error('ntfy Fehler:', e);
    return false;
  }
}

// â”€â”€â”€ ERINNERUNGEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function scheduleReminder(apt) {
  if (reminderTimers[apt.id]) clearTimeout(reminderTimers[apt.id]);
  const aptTime = new Date(apt.date + 'T' + apt.time);
  const reminderTime = new Date(aptTime.getTime() - (apt.reminder || 15) * 60 * 1000);
  const delay = reminderTime.getTime() - Date.now();
  if (delay > 0 && delay < 7 * 24 * 60 * 60 * 1000) {
    reminderTimers[apt.id] = setTimeout(async () => {
      const msg = `â° ERINNERUNG in ${apt.reminder || 15} Min!\n\nKunde: ${apt.name}\nUm: ${apt.time} Uhr${apt.phone ? '\nTel: ' + apt.phone : ''}${apt.note ? '\nğŸ“ ' + apt.note : ''}`;
      await sendNotification(msg, 'â° Gleich: ' + apt.name);
      const now = new Date().toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
      verlauf.unshift({ id: Date.now(), to: apt.name + ' (Erinnerung)', msg: msg.replace(/\n/g, ' '), time: now });
      saveVerlauf();
    }, delay);
  }
}

function scheduleAllReminders() {
  termine.forEach(apt => scheduleReminder(apt));
}

// â”€â”€â”€ HILFSFUNKTIONEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function formatDate(dateStr) {
  const d = new Date(dateStr + 'T12:00:00');
  return d.toLocaleDateString('de-DE', { weekday: 'short', day: '2-digit', month: '2-digit', year: 'numeric' });
}

function getCountdown(date) {
  const diff = date - new Date();
  if (diff < 0) return 'Vergangen';
  const h = Math.floor(diff / 3600000);
  const m = Math.floor((diff % 3600000) / 60000);
  if (h > 24) return Math.floor(h / 24) + ' Tage';
  if (h > 0) return h + 'h ' + m + 'min';
  if (m > 0) return m + ' Minuten';
  return 'Jetzt!';
}

function updateCountdowns() {
  if (currentView === 'list') renderTermine();
  if (currentView === 'kollege') renderKollegeTermine();
}

function showToast(msg, type = 'success') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'toast ' + type;
  t.style.display = 'block';
  setTimeout(() => t.style.display = 'none', 3500);
}

function saveTermine() { localStorage.setItem('tm_termine', JSON.stringify(termine)); }
function saveVerlauf() { localStorage.setItem('tm_verlauf', JSON.stringify(verlauf)); }

function resetApp() {
  if (!confirm('App wirklich zurÃ¼cksetzen? Alle Daten werden gelÃ¶scht.')) return;
  localStorage.clear();
  location.reload();
}

// â”€â”€â”€ START â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
init();
</script>
</body>
</html>
